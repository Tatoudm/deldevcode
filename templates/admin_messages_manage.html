{% extends "base.html" %}
{% block title %}DDC Admin – Gestion des messages{% endblock %}

{% block content %}

<div class="max-w-6xl mx-auto mt-8 space-y-6">

    {% if erreur %}
    <div class="mb-2">
        <div class="bg-red-50 text-red-800 border border-red-200 px-4 py-3 rounded-xl shadow-sm flex items-start gap-3">
            <span class="text-red-500 text-xl font-bold leading-none mt-0.5">!</span>
            <p class="text-sm md:text-base">
                {{ erreur }}
            </p>
        </div>
    </div>
    {% endif %}

    
    <section class="flex flex-col gap-2">
        <div>
            <p class="text-xs uppercase tracking-wide text-emerald-600 font-semibold">
                Panel administrateur
            </p>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900">
                Gestion des messages
            </h1>
            <p class="text-sm text-slate-600 pt-1">
                Bienvenue <span class="font-semibold">{{ nom }}</span>.
            </p>
        </div>

        <div class="flex flex-wrap gap-2 pt-4">
            <a href="{{ url_for('admin.admin_panel') }}" class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-700 hover:bg-slate-200">
                Gestion des utilisateurs
            </a>

            <a href="{{ url_for('admin.admin_messages_manage') }}" class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium bg-emerald-600 text-white">
                Gestion des messages
            </a>

            <a href="{{ url_for('admin.admin_support_list') }}" class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-700 hover:bg-slate-200">
                Gestion des tickets
            </a>
        </div>
    </section>

    
    <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
        <form method="GET" action="{{ url_for('admin.admin_messages_manage') }}" class="flex flex-col md:flex-row gap-3 md:items-end">
            <div class="flex-1">
                <label class="block text-xs font-semibold text-slate-600 mb-1">
                    Filtrer par auteur
                </label>
                <input type="text" name="author" value="{{ author }}" placeholder="Pseudo de l'auteur…" class="w-full text-sm px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
            </div>

            <div>
                <button type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-500 transition">
                    Rechercher
                </button>
            </div>
        </form>
    </section>

    
    <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-slate-900">
                Derniers messages (max 200)
            </h2>
            <p class="text-xs text-slate-500">
                Les messages avec des reports affichent le nombre de signalements.
            </p>
        </div>

        {% if messages %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
                <thead>
                    <tr class="border-b border-slate-200 bg-slate-50">
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Heure</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Canal</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Auteur</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Message</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Reports</th>
                        <th class="px-3 py-2 text-right font-semibold text-slate-600">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in messages %}
                    {% set report = reports_map.get(m.id) if reports_map else None %}
                    <tr id="msg-{{ m.id }}" class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="px-3 py-2 align-top whitespace-nowrap text-slate-600">
                            {{ m.time }}
                        </td>
                        <td class="px-3 py-2 align-top whitespace-nowrap text-slate-600">
                            {{ m.channel }}
                        </td>
                        <td class="px-3 py-2 align-top whitespace-nowrap">
                            {% if m.author %}
                            <a href="{{ url_for('admin.admin_user_by_name', nom=m.author) }}" class="font-semibold text-slate-800 hover:underline hover:text-emerald-700" target="_blank">
                                {{ m.author }}
                            </a>
                            {% else %}
                            <span class="text-slate-400">Inconnu</span>
                            {% endif %}
                        </td>

                        <td class="px-3 py-2 align-top">
                            <p class="text-slate-800 break-words max-w-xs md:max-w-md">
                                {{ m.content }}
                            </p>
                        </td>
                        <td class="px-3 py-2 align-top text-center">
                            {% if report %}
                                <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-full bg-red-50 text-red-600 text-[11px] font-semibold">
                                    {{ report.count }} report{{ 's' if report.count > 1 }}
                                </span>
                            {% else %}
                                <span class="text-[11px] text-slate-400">0</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 align-top text-right">
                            <form method="POST" action="{{ url_for('admin.admin_delete_message') }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="message_id" value="{{ m.id }}">
                                <input type="hidden" name="redirect_to" value="{{ url_for('admin.admin_messages_manage', author=author) }}">
                                <button class="text-[11px] text-red-500 hover:underline">
                                    Supprimer
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-sm text-slate-500">
            Aucun message trouvé.
        </p>
        {% endif %}
    </section>

    
    <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold text-slate-900">
                Messages les plus signalés
            </h2>
            <p class="text-xs text-slate-500">
                Triés par nombre de reports (du plus signalé au moins signalé).
            </p>
        </div>

        {% if reported_messages %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
                <thead>
                    <tr class="border-b border-slate-200 bg-slate-50">
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Heure</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Canal</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Auteur</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Message</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Nb reports</th>
                        <th class="px-3 py-2 text-left font-semibold text-slate-600">Reporté par</th>
                        <th class="px-3 py-2 text-right font-semibold text-slate-600">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in reported_messages %}
                    <tr id="msg-{{ r.id }}" class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="px-3 py-2 align-top whitespace-nowrap text-slate-600">
                            {{ r.time }}
                        </td>
                        <td class="px-3 py-2 align-top whitespace-nowrap text-slate-600">
                            {{ r.channel }}
                        </td>
                        <td class="px-3 py-2 align-top whitespace-nowrap">
                            {% if r.author %}
                            <a href="{{ url_for('admin.admin_user_by_name', nom=r.author) }}" class="font-semibold text-slate-800 hover:underline hover:text-emerald-700" target="_blank">
                                {{ r.author }}
                            </a>
                            {% else %}
                            <span class="text-slate-400">Inconnu</span>
                            {% endif %}
                        </td>

                        <td class="px-3 py-2 align-top">
                            <p class="text-slate-800 break-words max-w-xs md:max-w-md">
                                {{ r.content }}
                            </p>
                        </td>
                        <td class="px-3 py-2 align-top">
                            <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-full bg-red-50 text-red-600 text-[11px] font-semibold">
                                {{ r.report_count }}
                            </span>
                        </td>
                        <td class="px-3 py-2 align-top">
                            {% if r.reporters %}
                                <p class="text-[11px] text-slate-700 break-words max-w-xs">
                                    {{ r.reporters | join(", ") }}
                                </p>
                            {% else %}
                                <span class="text-[11px] text-slate-400">–</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 align-top text-right">
                            <form method="POST" action="{{ url_for('admin.admin_delete_message') }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="message_id" value="{{ r.id }}">
                                <input type="hidden" name="redirect_to" value="{{ url_for('admin.admin_messages_manage') }}">
                                <button class="text-[11px] text-red-500 hover:underline">
                                    Supprimer
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-sm text-slate-500">
            Aucun message n’a encore été signalé.
        </p>
        {% endif %}
    </section>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    let ws = new WebSocket("wss://deldevcode.org/ws/chat");

    ws.onmessage = (event) => {
        let data = JSON.parse(event.data);

        if (data.type === "message") {
            addMessageToAdminTable(data.message);
        }

        if (data.type === "message_deleted") {
            let row = document.getElementById("msg-" + data.id);
            if (row) row.remove();
        }
    };

});
</script>


{% endblock %}
