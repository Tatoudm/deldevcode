{% extends "base.html" %}
{% block title %}Outils d√©veloppeur ¬∑ DelDevCode{% endblock %}

{% block content %}

<div class="max-w-6xl mx-auto mt-8 space-y-8">

    
    <div class="bg-slate-900 text-white rounded-2xl p-6 md:p-8 shadow-lg flex flex-col md:flex-row items-start md:items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl bg-sky-500/20 flex items-center justify-center text-2xl">
                üß∞
            </div>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold">Portail d√©veloppeur</h1>
                <p class="text-sm md:text-base text-slate-200">
                    G√®re ta cl√© d'API et utilise les endpoints DelDevCode pour interagir avec le chat.
                </p>
            </div>
        </div>
        {% if current_nom %}
        <div class="md:ml-auto flex items-center gap-2 mt-3 md:mt-0">
            <img src="{{ current_pdp }}" alt="Avatar" class="w-10 h-10 rounded-full border border-white/30 object-cover">
            <div class="text-sm">
                <div class="font-semibold">{{ current_nom }}</div>
                <div class="text-xs text-slate-300">Compte connect√©</div>
            </div>
        </div>
        {% endif %}
    </div>

    
    {% if error %}
    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-xl shadow-sm">
        <div class="flex items-start gap-3">
            <div class="text-xl mt-0.5">‚ö†Ô∏è</div>
            <div class="space-y-1">
                <p class="font-semibold">Action impossible</p>
                <p class="text-sm">
                    {{ error }}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    
    {% if new_key %}
    <div class="bg-amber-50 border border-amber-200 text-amber-900 px-4 py-3 rounded-xl shadow-sm">
        <div class="flex items-start gap-3">
            <div class="text-xl mt-0.5">‚ö†Ô∏è</div>
            <div class="space-y-1">
                <p class="font-semibold">Nouvelle cl√© d'API g√©n√©r√©e</p>
                <p class="text-sm">
                    Copie cette cl√© maintenant, elle ne sera <span class="font-semibold">plus jamais</span> affich√©e :
                </p>
                <pre class="mt-2 bg-amber-100 border border-amber-200 rounded-lg px-3 py-2 text-xs md:text-sm overflow-x-auto">
{{ new_key }}</pre>
                <p class="text-xs text-amber-800 mt-1">
                    Garde-la secr√®te : ne la partage jamais en public, ni dans des captures d'√©cran.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-6">
        <div class="flex flex-col md:flex-row md:items-center gap-3">
            <div>
                <h2 class="text-lg font-semibold text-slate-900">Ma cl√© d'API</h2>
                <p class="text-sm text-slate-500">
                    Tu peux avoir <span class="font-semibold">au maximum une seule</span> cl√© d'API active en m√™me temps.
                    Par d√©faut, le plan <span class="font-semibold">free</span> offre jusqu'√†
                    <span class="font-semibold">60 requ√™tes / minute</span>.
                </p>
            </div>

            
            <form method="POST" action="{{ url_for('dev.dev_create_api_key') }}" class="md:ml-auto flex flex-col md:flex-row gap-2 md:items-center">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <input type="text" name="label" placeholder="Nom de la cl√© (optionnel)" class="w-full md:w-64 px-3 py-2 border border-slate-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                <button type="submit" class="inline-flex justify-center items-center px-4 py-2 rounded-xl text-sm font-medium bg-sky-600 text-white hover:bg-sky-700 transition shadow-sm">
                    ‚ûï G√©n√©rer une cl√©
                </button>
            </form>
        </div>

        {% if keys %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm border-collapse">
                <thead>
                    <tr class="bg-slate-50 text-slate-600">
                        <th class="text-left px-3 py-2 rounded-l-lg">Nom</th>
                        <th class="text-left px-3 py-2">Plan & limite</th>
                        <th class="text-left px-3 py-2">Scopes</th>
                        <th class="text-left px-3 py-2">Cr√©√©e le</th>
                        <th class="text-left px-3 py-2">Derni√®re utilisation</th>
                        <th class="text-right px-3 py-2 rounded-r-lg">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for k in keys %}
                    <tr class="hover:bg-slate-50/70">
                        <td class="px-3 py-2 font-medium text-slate-900">
                            {{ k.label }}
                        </td>

                        
                        <td class="px-3 py-2 text-slate-700 text-xs">
                            <div class="flex flex-col gap-1">
                                <span class="inline-flex items-center w-fit px-2 py-0.5 rounded-full border text-[11px] font-medium
                                    {% if k.tier == 'plus' %}
                                        bg-purple-50 text-purple-700 border-purple-200
                                    {% else %}
                                        bg-emerald-50 text-emerald-700 border-emerald-200
                                    {% endif %}
                                ">
                                    {% if k.tier %}
                                        Plan {{ k.tier|capitalize }}
                                    {% else %}
                                        Plan Free
                                    {% endif %}
                                </span>
                                <span class="text-[11px] text-slate-500">
                                    Limite : {{ k.rate_limit_per_minute }} req/min
                                </span>
                            </div>
                        </td>

                        <td class="px-3 py-2 text-slate-700">
                            {{ k.scopes }}
                        </td>
                        <td class="px-3 py-2 text-slate-700">
                            {% if k.created_at %}
                                {{ k.created_at.strftime("%d/%m/%Y %H:%M") }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-slate-700">
                            {% if k.last_used_at %}
                                {{ k.last_used_at.strftime("%d/%m/%Y %H:%M") }}
                            {% else %}
                                Jamais
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-right">
                            <form method="POST" action="{{ url_for('dev.dev_revoke_api_key', key_id=k.id) }}" onsubmit="return confirm('Tu es s√ªr de vouloir r√©voquer (et supprimer) cette cl√© ?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="inline-flex items-center px-3 py-1.5 rounded-xl text-xs font-medium bg-red-50 text-red-700 border border-red-200 hover:bg-red-100 transition">
                                    üö´ R√©voquer
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-sm text-slate-500">
            Tu n'as encore aucune cl√© d'API. G√©n√®re-en une pour commencer √† utiliser l'API d√©veloppeur.
        </p>
        {% endif %}
    </div>

    
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-4">
        <div class="flex items-center gap-2">
            <h2 class="text-lg font-semibold text-slate-900">Documentation rapide de l'API</h2>
            <span class="text-xs px-2 py-0.5 rounded-full bg-sky-50 text-sky-700 border border-sky-100">
                Version 1
            </span>
        </div>

        <p class="text-sm text-slate-600">
            Tous les endpoints ci-dessous utilisent une cl√© d'API (header
            <code class="px-1 py-0.5 rounded bg-slate-100 text-xs">X-API-Key</code>).
        </p>

        <div class="grid md:grid-cols-2 gap-4 text-sm">
            
            <div class="border border-slate-200 rounded-xl p-4 space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
                        GET /api/dev/v1/messages/general
                    </span>
                    <span class="text-[10px] text-slate-400 uppercase tracking-wide">Lecture</span>
                </div>
                <p class="text-slate-600">
                    R√©cup√®re les messages du chat g√©n√©ral.
                </p>
                <ul class="list-disc list-inside text-slate-600 text-xs space-y-1">
                    <li><code>limit</code> (optionnel) : nombre max de messages (1‚Äì500, d√©faut 100)</li>
                    <li><code>since</code> (optionnel) : date ISO8601 pour ne prendre que les messages r√©cents</li>
                </ul>
                <p class="text-xs font-semibold text-slate-700 mt-2">Exemple :</p>
<pre class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 overflow-x-auto text-[11px]">
GET /api/dev/v1/messages/general?limit=50&since=2025-01-01T00:00:00Z
X-API-Key: VOTRE_CLE_API
</pre>
            </div>

            
            <div class="border border-slate-200 rounded-xl p-4 space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
                        GET /api/dev/v1/messages/group/<group_id>
                    </span>
                    <span class="text-[10px] text-slate-400 uppercase tracking-wide">Lecture</span>
                </div>
                <p class="text-slate-600">
                    R√©cup√®re les messages d'un groupe auquel tu as acc√®s (tu dois √™tre membre du groupe).
                </p>
                <ul class="list-disc list-inside text-slate-600 text-xs space-y-1">
                    <li><code>limit</code> (optionnel) : nombre max de messages (1‚Äì500, d√©faut 100)</li>
                    <li><code>since</code> (optionnel) : date ISO8601</li>
                </ul>
                <p class="text-xs font-semibold text-slate-700 mt-2">Exemple :</p>
<pre class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 overflow-x-auto text-[11px]">
GET /api/dev/v1/messages/group/69295bd1f1be01aa51fe92bc?limit=100
X-API-Key: VOTRE_CLE_API
</pre>
            </div>
        </div>

        <div class="border border-dashed border-slate-200 rounded-xl p-4 text-xs text-slate-600 space-y-1">
            <p class="font-semibold text-slate-800">Codes de retour :</p>
            <ul class="list-disc list-inside space-y-0.5">
                <li><span class="font-semibold">200</span> : OK, r√©sultat renvoy√©</li>
                <li><span class="font-semibold">401</span> : cl√© d'API manquante</li>
                <li><span class="font-semibold">403</span> : cl√© d'API invalide / r√©voqu√©e ou acc√®s refus√© (groupe)</li>
                <li><span class="font-semibold">404</span> : groupe introuvable</li>
            </ul>
        </div>
    </div>

</div>

{% endblock %}
